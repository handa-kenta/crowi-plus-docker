box: docker:stable


prepare-to-release:
  steps:
    - script:
      name: bump version
      code: |
        NEW_APP_VERSION=v$RELEASE_VERSION ./bin/bump-version.sh

    - script:
      name: git commit
      code: |
        ./bin/init-git.sh
        git commit -am ":+1: version"

    - script:
      name: push to github
      code: |
        git push -u origin HEAD:$WERCKER_GIT_BRANCH

    - script:
      name: push to github to create new branch
      code: |
        git checkout -B tmp/release-$RELEASE_VERSION
        git push -u origin HEAD:tmp/release-$RELEASE_VERSION


release-to-github: # would be run on temporary release branch
  steps:
    -script:
      name: get version from branch name
      code: |
        export RELEASE_VERSION=`echo $WERCKER_GIT_BRANCH | sed -e 's/tmp\/release-//'`

    - github-create-release:
      token: $GITHUB_TOKEN
      tag: v$RELEASE_VERSION

    - script:
      name: remove temporary release branch
      code: |
        ./bin/init-git.sh
        # remove branch
        git push --delete origin $WERCKER_GIT_BRANCH


# the pipeline that do nothing
#  this is needed while wercker can't detect specified branch pushed
empty:
  steps:
    - script:
      code: echo "this is $WERCKER_GIT_BRANCH branch"
